<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API CivilX</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { padding: 8px; width: 250px; border: 1px solid #ccc; border-radius: 3px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .code { background: #f8f9fa; padding: 10px; border: 1px solid #e9ecef; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        .clear-btn { background: #dc3545; }
        .clear-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>üîç –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API CivilX</h1>
    
    <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è -->
    <div class="test-section">
        <h3>üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
        <button onclick="checkCurrentState()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å localStorage</button>
        <div id="currentState" class="result info" style="display: none;"></div>
    </div>
    
    <!-- –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="test-section">
        <h3>üîê –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
        <div class="form-group">
            <label for="email">Email:</label>
            <input type="email" id="email" value="test@example.com" placeholder="–í–≤–µ–¥–∏—Ç–µ email">
        </div>
        <div class="form-group">
            <label for="password">–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" id="password" value="password123" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        </div>
        <button onclick="testLogin()">–¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</button>
        <div id="loginResult" class="result" style="display: none;"></div>
    </div>
    
    <!-- –¢–µ—Å—Ç API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ -->
    <div class="test-section">
        <h3>üåê –¢–µ—Å—Ç API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤</h3>
        <button onclick="testApiEndpoints()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã</button>
        <div id="apiResult" class="result" style="display: none;"></div>
    </div>
    
    <!-- –¢–µ—Å—Ç –õ–ö -->
    <div class="test-section">
        <h3>üë§ –¢–µ—Å—Ç –õ–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞</h3>
        <button onclick="testDashboard()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –õ–ö</button>
        <div id="dashboardResult" class="result" style="display: none;"></div>
    </div>
    
    <!-- –û—á–∏—Å—Ç–∫–∞ -->
    <div class="test-section">
        <h3>üßπ –û—á–∏—Å—Ç–∫–∞</h3>
        <button onclick="clearStorage()" class="clear-btn">–û—á–∏—Å—Ç–∏—Ç—å localStorage</button>
        <button onclick="location.reload()">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
    </div>
    
    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function checkCurrentState() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            const resultDiv = document.getElementById('currentState');
            
            resultDiv.style.display = 'block';
            
            if (token) {
                const tokenParts = token.split('.');
                resultDiv.className = 'result info';
                resultDiv.innerHTML = `
                    <h4>‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω</h4>
                    <p><strong>–¢–∏–ø:</strong> ${typeof token}</p>
                    <p><strong>–î–ª–∏–Ω–∞:</strong> ${token.length}</p>
                    <p><strong>–ß–∞—Å—Ç–µ–π:</strong> ${tokenParts.length}</p>
                    <p><strong>–§–æ—Ä–º–∞—Ç:</strong> ${tokenParts.length === 3 ? 'JWT ‚úÖ' : '–ù–ï JWT ‚ùå'}</p>
                    <p><strong>–ü—Ä–µ–≤—å—é:</strong> ${token.substring(0, 50)}...</p>
                    <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> ${user ? JSON.parse(user).name : '–ù–µ –Ω–∞–π–¥–µ–Ω'}</p>
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '<h4>‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω</h4><p>localStorage –ø—É—Å—Ç</p>';
            }
        }
        
        // –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';
            
            try {
                console.log('üîê –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                console.log('Email:', email);
                
                const response = await fetch('/auth-api.php/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                console.log('üì° Response status:', response.status);
                console.log('üì° Response headers:', [...response.headers.entries()]);
                
                const responseText = await response.text();
                console.log('üìÑ Response text:', responseText);
                console.log('üìè Response length:', responseText.length);
                
                if (!responseText.trim()) {
                    throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                const result = JSON.parse(responseText);
                console.log('üìä Parsed result:', result);
                
                if (result.token) {
                    const tokenParts = result.token.split('.');
                    console.log('üé´ Token analysis:');
                    console.log('  - Type:', typeof result.token);
                    console.log('  - Length:', result.token.length);
                    console.log('  - Parts:', tokenParts.length);
                    console.log('  - Preview:', result.token.substring(0, 50) + '...');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                    localStorage.setItem('authToken', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</h4>
                        <div class="code">–¢–æ–∫–µ–Ω: ${result.token.substring(0, 100)}...
–¢–∏–ø: ${typeof result.token}
–î–ª–∏–Ω–∞: ${result.token.length}
–ß–∞—Å—Ç–µ–π: ${tokenParts.length}
–§–æ—Ä–º–∞—Ç: ${tokenParts.length === 3 ? 'JWT ‚úÖ' : '–ù–ï JWT ‚ùå'}
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${result.user.name} (${result.user.email})</div>
                        <p><a href="/dashboard/" target="_blank">–ü–µ—Ä–µ–π—Ç–∏ –≤ –õ–ö</a></p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h4>‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h4>
                        <div class="code">–û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
–°—Ç–∞—Ç—É—Å: ${response.status}
–û—Ç–≤–µ—Ç: ${responseText}</div>
                    `;
                }
                
            } catch (error) {
                console.error('üí• –û—à–∏–±–∫–∞:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞</h4>
                    <div class="code">–û—à–∏–±–∫–∞: ${error.message}
Stack: ${error.stack}</div>
                `;
            }
        }
        
        // –¢–µ—Å—Ç API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
        async function testApiEndpoints() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤...';
            
            const endpoints = [
                { name: 'Available Versions', url: '/auth-api.php/api/available-versions', method: 'GET' },
                { name: 'Product Versions', url: '/auth-api.php/api/product-versions', method: 'GET' },
                { name: 'Subscription Products', url: '/auth-api.php/api/subscription-products', method: 'GET' }
            ];
            
            let results = [];
            
            for (const endpoint of endpoints) {
                try {
                    console.log(`üåê –¢–µ—Å—Ç–∏—Ä—É–µ–º ${endpoint.name}...`);
                    
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const responseText = await response.text();
                    const isJson = responseText.trim().startsWith('{') || responseText.trim().startsWith('[');
                    
                    results.push({
                        name: endpoint.name,
                        status: response.status,
                        ok: response.ok,
                        isJson: isJson,
                        length: responseText.length,
                        preview: responseText.substring(0, 100)
                    });
                    
                } catch (error) {
                    results.push({
                        name: endpoint.name,
                        status: 'ERROR',
                        ok: false,
                        error: error.message
                    });
                }
            }
            
            let html = '<h4>üåê –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤</h4>';
            results.forEach(result => {
                const statusClass = result.ok ? 'success' : 'error';
                html += `
                    <div class="result ${statusClass}">
                        <strong>${result.name}</strong><br>
                        –°—Ç–∞—Ç—É—Å: ${result.status}<br>
                        ${result.error ? `–û—à–∏–±–∫–∞: ${result.error}` : `
                        JSON: ${result.isJson ? '–î–∞' : '–ù–µ—Ç'}<br>
                        –î–ª–∏–Ω–∞: ${result.length}<br>
                        –ü—Ä–µ–≤—å—é: ${result.preview}...
                        `}
                    </div>
                `;
            });
            
            resultDiv.innerHTML = html;
        }
        
        // –¢–µ—Å—Ç –õ–ö
        async function testDashboard() {
            const token = localStorage.getItem('authToken');
            const resultDiv = document.getElementById('dashboardResult');
            
            resultDiv.style.display = 'block';
            
            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '<h4>‚ùå –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞</h4><p>–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å</p>';
                return;
            }
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –õ–ö...';
            
            try {
                console.log('üë§ –¢–µ—Å—Ç–∏—Ä—É–µ–º –õ–ö...');
                
                // –¢–µ—Å—Ç /api/me
                const meResponse = await fetch('/auth-api.php/api/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                const meText = await meResponse.text();
                console.log('üë§ /api/me response:', meText);
                
                // –¢–µ—Å—Ç /api/user-products
                const productsResponse = await fetch('/auth-api.php/api/user-products', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                const productsText = await productsResponse.text();
                console.log('üì¶ /api/user-products response:', productsText);
                
                let html = '<h4>üë§ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –õ–ö</h4>';
                
                // –†–µ–∑—É–ª—å—Ç–∞—Ç /api/me
                html += `
                    <div class="result ${meResponse.ok ? 'success' : 'error'}">
                        <strong>/api/me</strong><br>
                        –°—Ç–∞—Ç—É—Å: ${meResponse.status}<br>
                        –î–ª–∏–Ω–∞: ${meText.length}<br>
                        –ü—Ä–µ–≤—å—é: ${meText.substring(0, 100)}...
                    </div>
                `;
                
                // –†–µ–∑—É–ª—å—Ç–∞—Ç /api/user-products
                html += `
                    <div class="result ${productsResponse.ok ? 'success' : 'error'}">
                        <strong>/api/user-products</strong><br>
                        –°—Ç–∞—Ç—É—Å: ${productsResponse.status}<br>
                        –î–ª–∏–Ω–∞: ${productsText.length}<br>
                        –ü—Ä–µ–≤—å—é: ${productsText.substring(0, 100)}...
                    </div>
                `;
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('üí• –û—à–∏–±–∫–∞ –õ–ö:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <h4>‚ùå –û—à–∏–±–∫–∞ –õ–ö</h4>
                    <div class="code">–û—à–∏–±–∫–∞: ${error.message}</div>
                `;
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ localStorage
        function clearStorage() {
            localStorage.clear();
            alert('localStorage –æ—á–∏—â–µ–Ω!');
            location.reload();
        }
        
        // –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É...');
            checkCurrentState();
        };
    </script>
</body>
</html>
