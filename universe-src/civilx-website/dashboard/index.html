<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <base href="/">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - CivilX</title>
    <script>
        // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        (function() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                window.location.href = './auth/';
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                document.addEventListener('DOMContentLoaded', function() {
                    document.body.classList.add('auth-checked');
                });
            }
        })();
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif; 
            background: linear-gradient(135deg, #000 0%, #0a0a0a 25%, #1a1a1a 50%, #0f0f0f 75%, #000 100%);
            color: #fff; 
            line-height: 1.6; 
            min-height: 100vh;
            overflow-x: hidden;
            /* –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
            visibility: hidden;
        }
        
        body.auth-checked {
            visibility: visible;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        
        /* Header with Linear.app style */
        .header { 
            position: fixed; 
            top: 0; left: 0; right: 0; 
            background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            z-index: 50; 
            transition: all 0.3s ease;
        }
        .header-content { 
            display: flex; 
            align-items: center;
            justify-content: space-between;
            height: 4rem; 
            align-items: center; 
            padding: 1rem 0; 
        }
        .logo { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #fff; 
            text-decoration: none; 
        }
        .nav { 
            display: flex; 
            gap: 0.5rem; 
        }
        
        .nav a { 
            color: #fff; 
            text-decoration: none; 
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease; 
            position: relative;
            overflow: hidden;
        }
        
        .nav a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(20,184,166,0.2), transparent);
            transition: left 0.5s;
        }
        
        .nav a:hover::before {
            left: 100%;
        }
        
        .nav a:hover { 
            background: rgba(20,184,166,0.1); 
            color: #14b8a6; 
            transform: translateY(-2px);
        }
        .user-info { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
        }
        .user-avatar { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(20,184,166,0.3);
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(20,184,166,0.4);
        }
        
        .logout-btn { 
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
            color: white; 
            border: none; 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-weight: 600;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(220,53,69,0.3);
        }
        
        .logout-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .logout-btn:hover::before {
            left: 100%;
        }
        
        .logout-btn:hover { 
            background: linear-gradient(135deg, #c82333 0%, #dc3545 100%); 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220,53,69,0.4);
        }
        
        /* Main Content with Linear.app style */
        .main { 
            padding-top: 6rem; 
            min-height: 100vh; 
            position: relative;
            overflow: hidden;
        }
        
        .main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(20,184,166,0.05) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .dashboard-header { 
            text-align: center; 
            margin-bottom: 4rem; 
            position: relative;
            z-index: 1;
        }
        
        .dashboard-title { 
            font-size: 3rem; 
            font-weight: 700;
            margin-bottom: 1rem; 
            background: linear-gradient(135deg, #fff 0%, #14b8a6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeInUp 1s ease-out;
        }
        
        .dashboard-subtitle { 
            font-size: 1.25rem; 
            opacity: 0.8; 
            animation: fadeInUp 1s ease-out 0.2s both;
        }
        
        /* Dashboard Grid */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 2rem; 
            margin-bottom: 3rem; 
        }

        .download-card {
            grid-column: 1 / -1;
        }
        .dashboard-card { 
            background: rgba(31,41,55,0.6); 
            border-radius: 1.5rem; 
            padding: 2.5rem; 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: all 0.3s ease; 
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(20,184,166,0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .dashboard-card:hover::before {
            opacity: 1;
        }
        
        .dashboard-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
            border-color: rgba(20,184,166,0.3);
        }
        .card-icon { 
            font-size: 3rem; 
            margin-bottom: 1rem; 
        }
        .card-title { 
            font-size: 1.5rem; 
            margin-bottom: 1rem; 
            font-weight: bold; 
        }
        .card-description { 
            opacity: 0.9; 
            margin-bottom: 1.5rem; 
        }
        .card-btn { 
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); 
            color: #000; 
            border: none; 
            padding: 1rem 2rem; 
            border-radius: 0.75rem; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            text-decoration: none; 
            display: inline-block; 
            font-weight: 600;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(20,184,166,0.3);
        }
        
        .card-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .card-btn:hover::before {
            left: 100%;
        }
        
        .card-btn:hover { 
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(20,184,166,0.4);
        }
        
        /* User Profile */
        .profile-section { 
            background: rgba(255,255,255,0.1); 
            border-radius: 15px; 
            padding: 2rem; 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.2); 
            margin-bottom: 2rem; 
        }
        .profile-header { 
            display: flex; 
            align-items: center; 
            gap: 2rem; 
            margin-bottom: 2rem; 
        }
        .profile-avatar { 
            width: 100px; 
            height: 100px; 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 2.5rem; 
            font-weight: bold; 
        }
        .profile-info h2 { 
            font-size: 2rem; 
            margin-bottom: 0.5rem; 
        }
        .profile-info p { 
            opacity: 0.8; 
            font-size: 1.1rem; 
        }
        .profile-details { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 1rem; 
        }
        .detail-item { 
            background: rgba(255,255,255,0.1); 
            padding: 1rem; 
            border-radius: 10px; 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        .detail-label { 
            font-weight: bold; 
            margin-bottom: 0.5rem; 
            opacity: 0.8; 
        }
        .detail-value { 
            font-size: 1.1rem; 
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 1rem; }
            .nav { gap: 1rem; }
            .dashboard-title { font-size: 2rem; }
            .profile-header { flex-direction: column; text-align: center; }
        }
        
        /* Loading */
        .loading { 
            display: none; 
            text-align: center; 
            padding: 2rem; 
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .main {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        
        .main.loaded {
            opacity: 1;
        }
        
        .auth-checking {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            font-size: 1.2rem;
        }
        
        .auth-checking.hidden {
            display: none;
        }
        .spinner { 
            width: 40px; 
            height: 40px; 
            border: 4px solid rgba(255,255,255,0.3); 
            border-top: 4px solid #fff; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 1rem; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Error */
        .error { 
            background: rgba(220, 53, 69, 0.2); 
            border: 1px solid #dc3545; 
            color: #fff; 
            padding: 1rem; 
            border-radius: 10px; 
            margin: 1rem 0; 
        }
        
        /* User Products */
        .products-section { margin-bottom: 3rem; }
        .user-products-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 1.5rem; 
        }
        .user-product-card { 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
            padding: 1.5rem; 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        .product-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1rem; 
        }
        .product-name { 
            font-size: 1.2rem; 
            font-weight: bold; 
        }
        .product-plan { 
            background: rgba(20,184,166,0.2); 
            color: #14b8a6; 
            padding: 0.25rem 0.75rem; 
            border-radius: 15px; 
            font-size: 0.8rem; 
        }
        .product-login {
            background: rgba(248,249,250,0.8);
            border: 1px solid rgba(233,236,239,0.5);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #495057;
            backdrop-filter: blur(10px);
        }
        
        .products-card {
            grid-column: 1 / -1;
            max-width: none;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .card-title-section {
            flex: 1;
        }
        
        .products-table-container {
            margin-top: 1rem;
        }
        
        .products-table {
            background: rgba(255,255,255,0.05);
            border-radius: 0.75rem;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Download Section Styles */
        .download-section {
            margin-top: 1rem;
        }

        .download-controls {
            background: rgba(255,255,255,0.05);
            border-radius: 0.75rem;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: nowrap;
            width: 100%;
            box-sizing: border-box;
        }

        .download-controls label {
            min-width: auto;
            font-weight: 500;
            color: #fff;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .download-select {
            min-width: 150px;
            flex: 1;
            max-width: 250px;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.5rem;
            color: #fff;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .download-select:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255,255,255,0.15);
        }

        .download-select option {
            background: #2a2a2a;
            color: #fff;
        }

        .download-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 180px;
            flex-shrink: 0;
            justify-content: center;
            white-space: nowrap;
            margin-left: auto;
        }

        .download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .download-btn:disabled {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .download-icon {
            font-size: 1.2rem;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 768px) {
            .download-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .download-controls label {
                text-align: left;
            }
            
            .download-select {
                min-width: auto;
                width: 100%;
            }
            
            .download-btn {
                min-width: auto;
                width: 100%;
            }
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            font-weight: 600;
            color: #fff;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            align-items: center;
            transition: background-color 0.3s ease;
        }
        
        .table-row:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        .product-name-cell {
            font-weight: 600;
            color: #fff;
        }
        
        .group-cell {
            text-align: center;
            font-weight: 500;
            color: #14b8a6;
        }
        
        .plan-cell {
            text-align: center;
        }
        
        .status-cell {
            text-align: center;
        }
        
        .login-cell {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #14b8a6;
            font-weight: 500;
        }
        
        .purchase-date-cell {
            font-size: 0.9rem;
            color: #ccc;
            text-align: center;
        }
        
        .expiry-date-cell {
            font-size: 0.9rem;
            color: #ccc;
            text-align: center;
        }
        
        .actions-cell {
            text-align: center;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-purchased {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .status-expired {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .btn-cancel {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .btn-cancel:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .btn-download {
            background: rgba(5, 150, 105, 0.2);
            color: #10b981;
            border: 1px solid rgba(5, 150, 105, 0.3);
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
        }
        
        .btn-download:hover {
            background: rgba(5, 150, 105, 0.3);
        }
        
        .trash-icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–µ—Ä—Å–∏–∏ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }
        
        .close {
            color: #9ca3af;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close:hover {
            color: #fff;
        }
        
        .version-selector {
            margin-bottom: 1.5rem;
        }
        
        .version-selector label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #d1d5db;
        }
        
        .version-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(31, 41, 55, 0.8);
            color: #fff;
            font-size: 1rem;
        }
        
        .version-selector select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .version-info {
            background: rgba(31, 41, 55, 0.5);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .version-info h4 {
            color: #fff;
            margin-bottom: 0.5rem;
        }
        
        .version-info p {
            color: #9ca3af;
            margin: 0.25rem 0;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .btn-modal {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-modal-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-modal-primary:hover {
            background: #5a67d8;
        }
        
        .btn-modal-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #d1d5db;
        }
        
        .btn-modal-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* –†–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è —Å–ø–∏—Å–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ */
        .expandable-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .expandable-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .expand-arrow {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 8px;
        }
        
        .expand-arrow.expanded {
            transform: rotate(180deg);
        }
        
        .product-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 0;
        }
        
        .product-details.expanded {
            max-height: 500px;
            opacity: 1;
        }
        
        .product-row {
            background: rgba(31, 41, 55, 0.3);
            border-left: 3px solid #667eea;
            margin: 8px 0;
            padding: 16px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            align-items: center;
            gap: 16px;
        }
        
        .product-name {
            font-weight: 600;
            color: #fff;
            min-width: 120px;
        }
        
        .version-selector-small {
            min-width: 120px;
        }
        
        .version-selector-small select {
            padding: 6px 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            background: rgba(31, 41, 55, 0.8);
            color: #fff;
            font-size: 0.875rem;
        }
        
        .version-selector-small select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-download-small {
            background: rgba(5, 150, 105, 0.2);
            color: #10b981;
            border: 1px solid rgba(5, 150, 105, 0.3);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .btn-download-small:hover {
            background: rgba(5, 150, 105, 0.3);
        }
        
        .btn-download-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ü–∏–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–π */
        .activations-section {
            margin-top: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .activations-section h4 {
            margin: 0 0 12px 0;
            color: #e5e7eb;
            font-size: 14px;
            font-weight: 600;
        }
        
        .activation-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .activation-row:last-child {
            border-bottom: none;
        }
        
        .revit-version {
            font-weight: 600;
            color: #f3f4f6;
            min-width: 100px;
        }
        
        .product-version {
            color: #d1d5db;
            min-width: 120px;
        }
        
        .activation-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }
        
        .activation-status.active {
            background: #10b981;
            color: white;
        }
        
        .activation-status.inactive {
            background: #fbbf24; /* –ñ–µ–ª—Ç—ã–π —Ü–≤–µ—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ì–æ—Ç–æ–≤" */
            color: #1f2937; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
        }
        
        .btn-activate {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .btn-activate:hover {
            background: #2563eb;
        }
        
        .btn-activate:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
        
        .activation-note {
            color: #6b7280;
            font-size: 12px;
            font-style: italic;
        }
        
        
        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        /* Scroll animations */
        .fade-in {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.6s ease;
        }
        
        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .cache-info {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 4px;
        }
        
        .settings-card {
            grid-column: 1 / -1;
            max-width: none;
        }
        
        .settings-container {
            margin-top: 1rem;
        }
        
        .settings-content {
            background: rgba(255,255,255,0.05);
            border-radius: 0.75rem;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .settings-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ccc;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.5rem;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #14b8a6;
        }
        
        .form-group input::placeholder {
            color: #999;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .btn-save {
            background: rgba(20,184,166,0.2);
            color: #14b8a6;
            border: 1px solid rgba(20,184,166,0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-save:hover {
            background: rgba(20,184,166,0.3);
        }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .danger-zone {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .danger-zone .section-title {
            color: #ef4444;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.2);
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #14b8a6;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .loading-settings {
            text-align: center;
            padding: 2rem;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .table-header,
            .table-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .table-header {
                display: none;
            }
            
            .table-row {
                display: block;
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 0.5rem;
                background: rgba(255,255,255,0.05);
            }
        }
        .product-status { 
            display: flex; 
            gap: 1rem; 
            margin-bottom: 1rem; 
        }
        .status-badge { 
            padding: 0.25rem 0.75rem; 
            border-radius: 15px; 
            font-size: 0.8rem; 
            font-weight: bold; 
        }
        .status-purchased { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-pending { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .status-ready { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .status-active { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status-expired { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .product-dates { 
            color: #ccc; 
            font-size: 0.9rem; 
            margin-bottom: 1rem; 
        }
        .product-actions { 
            display: flex; 
            gap: 0.5rem; 
        }
        .btn-small { 
            padding: 0.5rem 1rem; 
            font-size: 0.8rem; 
            border-radius: 5px; 
        }
        .btn-cancel { 
            background: #dc3545; 
            color: white; 
        }
        .btn-cancel:hover { background: #c82333; }
        .loading-products { 
            text-align: center; 
            padding: 2rem; 
            grid-column: 1 / -1; 
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="./" class="logo">
                    <img src="./main_icon.svg" alt="CivilX" style="height: 120px; margin-top: 10px;">
                </a>
                <nav class="nav">
                    <a href="./">–û –Ω–∞—Å</a>
                    <a href="./pricing/">–ü—Ä–æ–¥—É–∫—Ç</a>
                    <a href="./subscriptions/">–ü–æ–¥–ø–∏—Å–∫–∏</a>
                </nav>
                <div class="user-info">
        <div class="user-avatar" id="userAvatar">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-icon lucide-user">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        </div>
                    <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </header>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-checking" id="authChecking">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <p style="margin-top: 1rem;">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</p>
        </div>
    </div>

    <main class="main">
        <div class="container">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>

            <div id="errorMessage" class="error" style="display: none;"></div>

            <div id="dashboardContent" style="display: none;">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
                    <p class="dashboard-subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É CivilX</p>
                </div>

                <!-- User Profile Section -->
                <div class="profile-section">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-icon lucide-user">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <div class="profile-info">
                            <h2 id="profileName">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                            <p id="profileType">–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
                        </div>
                    </div>
                    <div class="profile-details">
                        <div class="detail-item">
                            <div class="detail-label">–õ–æ–≥–∏–Ω</div>
                            <div class="detail-value" id="profileLogin">user_login</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value" id="profileEmail">user@example.com</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–¢–∏–ø –∞–∫–∫–∞—É–Ω—Ç–∞</div>
                            <div class="detail-value" id="profileUserType">–§–∏–∑–∏—á–µ—Å–∫–æ–µ –ª–∏—Ü–æ</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–ö–æ–º–ø–∞–Ω–∏—è</div>
                            <div class="detail-value" id="profileCompany">–ù–µ —É–∫–∞–∑–∞–Ω–æ</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                            <div class="detail-value" id="profilePhone">–ù–µ —É–∫–∞–∑–∞–Ω–æ</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</div>
                            <div class="detail-value" id="profileCreated">–ù–µ —É–∫–∞–∑–∞–Ω–æ</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">–°—Ç–∞—Ç—É—Å</div>
                            <div class="detail-value" style="color: #28a745;">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</div>
                        </div>
                    </div>
                </div>


                <!-- Dashboard Cards -->
                <div class="dashboard-grid">
                    <!-- –°–µ–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–µ—Ä—Å–∏–π -->
                    <div class="dashboard-card download-card">
                        <div class="card-header">
                            <div class="card-icon">‚¨áÔ∏è</div>
                            <div class="card-title-section">
                                <h3 class="card-title">–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–π</h3>
                                <p class="card-description">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é Revit –∏ —Å–∫–∞—á–∞–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫</p>
                            </div>
                        </div>
                        <div class="download-section">
                            <div class="download-controls">
                                <label for="revitVersionSelect">–í–µ—Ä—Å–∏—è Revit:</label>
                                <select id="revitVersionSelect" class="download-select">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é Revit</option>
                                </select>
                                
                                <label for="productVersionSelect">–í–µ—Ä—Å–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞:</label>
                                <select id="productVersionSelect" class="download-select">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞</option>
                                </select>
                                
                                <button id="downloadBtn" class="download-btn" disabled>
                                    <span class="download-icon">‚¨áÔ∏è</span>
                                    –°–∫–∞—á–∞—Ç—å MSI
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- –ü–∞–Ω–µ–ª—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
                    <div class="dashboard-card download-card">
                        <div class="card-header">
                            <div class="card-icon">üìö</div>
                            <div class="card-title-section">
                                <h3 class="card-title">–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
                                <p class="card-description">–°–∫–∞—á–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</p>
                            </div>
                        </div>
                        <div class="download-section">
                            <div class="download-controls">
                                <label for="helpMaterialSelect">–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:</label>
                                <select id="helpMaterialSelect" class="download-select">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>
                                </select>
                                
                                <button id="downloadHelpBtn" class="download-btn" disabled>
                                    <span class="download-icon">‚¨áÔ∏è</span>
                                    –°–∫–∞—á–∞—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ -->
                    <div class="dashboard-card products-card">
                        <div class="card-header">
                            <div class="card-icon">üì¶</div>
                            <div class="card-title-section">
                                <h3 class="card-title">–ü–æ–¥–ø–∏—Å–∫–∏</h3>
                                <p class="card-description">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã –ø–ª–∞–≥–∏–Ω–æ–≤ CivilX</p>
                            </div>
                            <a href="./subscriptions/" class="card-btn">–ö—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏</a>
                        </div>
                        <div class="products-table-container">
                            <div id="userProducts" class="products-table">
                                <div class="loading-products">
                                    <div class="spinner"></div>
                                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card settings-card">
                        <div class="card-header">
                            <div class="card-icon">‚öôÔ∏è</div>
                            <div class="card-title-section">
                                <h3 class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                                <p class="card-description">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø—Ä–æ—Ñ–∏–ª—è –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏</p>
                            </div>
                        </div>
                        <div class="settings-container">
                            <div id="settingsContent" class="settings-content">
                                <div class="loading-settings">
                                    <div class="spinner"></div>
                                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
        (function() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                window.location.href = './auth/';
                return;
            }
        })();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            if (!token || !user) {
                // –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                document.getElementById('authChecking').classList.add('hidden');
                setTimeout(() => {
                    window.location.href = './auth/';
                }, 300);
                return;
            }
            
            try {
                const userData = JSON.parse(user);
                displayUserInfo(userData);
                
                // –ü–ª–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                document.getElementById('authChecking').classList.add('hidden');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è
                setTimeout(() => {
                    document.querySelector('.main').classList.add('loaded');
                }, 100);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                document.getElementById('authChecking').classList.add('hidden');
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function displayUserInfo(user) {
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            document.getElementById('userName').textContent = user.name || user.email;
            document.getElementById('profileName').textContent = user.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            document.getElementById('profileType').textContent = getUserTypeDisplay(user.user_type);
            
            // –ê–≤–∞—Ç–∞—Ä
            const avatar = user.name ? user.name.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = avatar;
            document.getElementById('profileAvatar').textContent = avatar;
            
            // –î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('profileLogin').textContent = user.login || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('profileUserType').textContent = getUserTypeDisplay(user.user_type);
            document.getElementById('profileCompany').textContent = user.company_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            document.getElementById('profilePhone').textContent = user.phone || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            document.getElementById('profileCreated').textContent = user.created_at ? 
                new Date(user.created_at).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserTypeDisplay(userType) {
            const types = {
                'user': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                'organization': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'
            };
            return types[userType] || userType || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = './auth/';
            }
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function showSuccess(message) {
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ–∫—Ü–∏–µ–π —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        async function loadDownloadVersions() {
            try {
                // –ü—Ä–æ—Å—Ç–æ –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ –ø–∞–ø–∫–∏ installer
                const response = await fetch('/auth-api.php/api/available-versions', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load versions');
                }

                const data = await response.json();
                console.log('Available versions:', data);
                
                if (data.success && data.versions && data.versions.length > 0) {
                    populateDownloadSelects(data.versions);
                    // –ö–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–µ–ª–µ–∫—Ç–æ–≤
                } else {
                    console.error('No versions found:', data);
                }
            } catch (error) {
                console.error('Error loading download versions:', error);
            }
        }

        function populateDownloadSelects(versions) {
            console.log('Populating selects with versions:', versions);
            
            const revitSelect = document.getElementById('revitVersionSelect');
            const productSelect = document.getElementById('productVersionSelect');
            
            console.log('Elements in populateDownloadSelects:', {
                revitSelect: revitSelect,
                productSelect: productSelect
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
            if (!revitSelect || !productSelect) {
                console.error('Select elements not found:', {
                    revitSelect: !!revitSelect,
                    productSelect: !!productSelect
                });
                return;
            }
            
            // –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç—ã
            revitSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é Revit</option>';
            productSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞</option>';
            
            // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ Revit
            const revitVersions = [...new Set(versions.map(v => v.revit_version))].sort();
            console.log('Available Revit versions:', revitVersions);
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç –≤–µ—Ä—Å–∏–π Revit
            revitVersions.forEach(version => {
                const option = document.createElement('option');
                option.value = version;
                option.textContent = version;
                revitSelect.appendChild(option);
            });
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            revitSelect.removeEventListener('change', handleRevitChange);
            productSelect.removeEventListener('change', updateDownloadButton);
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–µ—Ä—Å–∏–∏ Revit
            function handleRevitChange() {
                const selectedRevit = this.value;
                productSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞</option>';
                
                if (selectedRevit) {
                    // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ Revit
                    const productVersions = versions
                        .filter(v => v.revit_version === selectedRevit)
                        .map(v => v.product_version)
                        .sort();
                    
                    productVersions.forEach(version => {
                        const option = document.createElement('option');
                        option.value = version;
                        option.textContent = version;
                        productSelect.appendChild(option);
                    });
                }
                
                // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ productSelect
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            revitSelect.addEventListener('change', handleRevitChange);
            productSelect.addEventListener('change', updateMSIDownloadButton);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            setTimeout(() => {
                try {
                    console.log('About to call updateMSIDownloadButton from populateDownloadSelects');
                    updateMSIDownloadButton();
                } catch (error) {
                    console.error('Error updating download button:', error);
                }
            }, 50);
        }

        function updateMSIDownloadButton() {
            try {
                console.log('updateMSIDownloadButton called');
                
                const revitSelect = document.getElementById('revitVersionSelect');
                const productSelect = document.getElementById('productVersionSelect');
                const downloadBtn = document.getElementById('downloadBtn');
                
                console.log('Elements found:', {
                    revitSelect: revitSelect,
                    productSelect: productSelect,
                    downloadBtn: downloadBtn
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã
                if (!revitSelect || !productSelect || !downloadBtn) {
                    console.error('Elements not found:', {
                        revitSelect: !!revitSelect,
                        productSelect: !!productSelect,
                        downloadBtn: !!downloadBtn
                    });
                    return;
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ value
                if (typeof revitSelect.value === 'undefined' || typeof productSelect.value === 'undefined') {
                    console.error('Select values are undefined');
                    return;
                }
                
                const isRevitSelected = revitSelect.value !== '';
                const isProductSelected = productSelect.value !== '';
                
                console.log('Update button:', {
                    revitValue: revitSelect.value,
                    productValue: productSelect.value,
                    isRevitSelected,
                    isProductSelected,
                    shouldEnable: isRevitSelected && isProductSelected
                });
                
                downloadBtn.disabled = !(isRevitSelected && isProductSelected);
            } catch (error) {
                console.error('Error in updateDownloadButton:', error);
            }
        }

        async function downloadMSI() {
            const revitVersion = document.getElementById('revitVersionSelect').value;
            const productVersion = document.getElementById('productVersionSelect').value;
            
            if (!revitVersion || !productVersion) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é Revit –∏ –≤–µ—Ä—Å–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞');
                return;
            }

            try {
                // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ API
                const fileName = `CivilX-${revitVersion}-v${productVersion}.msi`;
                const downloadUrl = `/auth-api.php/api/download-file?revit_version=${encodeURIComponent(revitVersion)}&product_version=${encodeURIComponent(productVersion)}`;
                
                console.log('Downloading:', downloadUrl);
                console.log('File name:', fileName);
                
                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                link.target = '_blank'; // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showSuccess('–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å!');

            } catch (error) {
                console.error('Download error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ' + error.message);
            }
        }

        async function loadUserProducts() {
            const token = localStorage.getItem('authToken');
            console.log('loadUserProducts: Token found:', token ? 'YES' : 'NO');
            console.log('loadUserProducts: Token value:', token);
            console.log('loadUserProducts: Token length:', token ? token.length : 0);
            console.log('loadUserProducts: Token parts:', token ? token.split('.').length : 0);
            if (!token) {
                console.log('loadUserProducts: No token, returning');
                return;
            }

            try {
                console.log('loadUserProducts: Making request to /api/user-products');
                console.log('loadUserProducts: Token being sent:', token.substring(0, 20) + '...');
                const response = await fetch('/auth-api.php/api/user-products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token
                    })
                });
                console.log('loadUserProducts: Response status:', response.status);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π
                const responseText = await response.text();
                console.log('loadUserProducts: Response text:', responseText);
                if (!responseText.trim()) {
                    throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                const result = JSON.parse(responseText);
                console.log('loadUserProducts: Parsed result:', result);
                
                if (response.ok && result.products) {
                    displayUserProducts(result.products);
                } else {
                    showNoProducts();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', error);
                showNoProducts();
            }
        }

               // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
               function displayUserProducts(products) {
                   console.log('displayUserProducts: Called with products:', products);
                   const container = document.getElementById('userProducts');
                   console.log('displayUserProducts: Container found:', container);
                   
                   // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã - —Å–∫—Ä—ã–≤–∞–µ–º –≥—Ä—É–ø–ø—É "authorization" –∏ "settings" –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                   const filteredProducts = products.filter(product => {
                       const pluginGroup = product.plugin_group || '';
                       return pluginGroup.toLowerCase() !== 'authorization' && 
                              pluginGroup.toLowerCase() !== 'settings';
                   });
                   
                   // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                   console.log('Products received:', products);
                   console.log('Filtered products:', filteredProducts);
                   if (filteredProducts.length > 0) {
                       console.log('First filtered product:', filteredProducts[0]);
                       console.log('First filtered product activation_status:', filteredProducts[0].activation_status);
                   }
                   
                   if (filteredProducts.length === 0) {
                       showNoProducts();
                       return;
                   }

                   const tableHTML = `
                       <div class="table-header">
                           <div>–ü–æ–¥–ø–∏—Å–∫–∞</div>
                           <div>–ì—Ä—É–ø–ø–∞</div>
                           <div>–ü–ª–∞–Ω</div>
                           <div>–õ–æ–≥–∏–Ω –ø–æ–∑–∏—Ü–∏–∏</div>
                           <div>–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</div>
                           <div>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</div>
                           <div>–î–µ–π—Å—Ç–≤–∏—è</div>
                       </div>
                       ${filteredProducts.map(product => {
                           const planText = product.plan_type === 'monthly' ? '–ú–µ—Å—è—á–Ω—ã–π' : '–ì–æ–¥–æ–≤–æ–π';
                           const purchaseDate = new Date(product.purchase_date).toLocaleDateString('ru-RU');
                           const expiresDate = product.expires_at ? new Date(product.expires_at).toLocaleDateString('ru-RU') : '–ù–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ';
                           
                           let statusText = '';
                           let statusClass = '';
                           
                           // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∫–∞–∫ 'ready'
                           const status = product.activation_status || 'ready';
                           
                           if (status === 'activated') {
                               statusText = '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω';
                               statusClass = 'status-active';
                           } else if (status === 'ready') {
                               statusText = 'üü° –ì–æ—Ç–æ–≤';
                               statusClass = 'status-ready';
                           } else if (status === 'pending') {
                               statusText = '‚è≥ –û–∂–∏–¥–∞–µ—Ç';
                               statusClass = 'status-pending';
                           } else if (status === 'expired') {
                               statusText = '‚ùå –ò—Å—Ç–µ–∫';
                               statusClass = 'status-expired';
                           } else {
                               // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
                               console.log('Unknown status:', status, 'for product:', product);
                               statusText = `‚ùì ${status}`;
                               statusClass = 'status-pending';
                           }

                           // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
                           let groupDisplayName = product.plugin_group || '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
                           if (groupDisplayName === 'Data') {
                               groupDisplayName = 'DataHub';
                           } else if (groupDisplayName === 'authorization' || groupDisplayName === 'settings') {
                               groupDisplayName = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏';
                           }

                           return `
                               <div class="table-row expandable-row" onclick="toggleProductDetails(${product.id}, '${product.plugin_group}')">
                                   <div class="product-name-cell">${getProductDisplayName(product.product_name)}</div>
                                   <div class="group-cell">${groupDisplayName}</div>
                                   <div class="plan-cell">${planText}</div>
                                   <div class="login-cell">${product.position_login || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                   <div class="purchase-date-cell">${purchaseDate}</div>
                                   <div class="expiry-date-cell">${expiresDate}</div>
                                   <div class="actions-cell">
                                       <div class="action-buttons">
                                           ${product.activation_status !== 'expired' && product.plugin_group !== 'settings' ? 
                                               `<button class="btn btn-small btn-cancel" onclick="event.stopPropagation(); cancelSubscription(${product.id})">–û—Ç–º–µ–Ω–∏—Ç—å</button>` : 
                                               ''
                                           }
                                           ${product.activation_status === 'expired' && product.plugin_group !== 'settings' ? 
                                               `<button class="btn-delete" onclick="event.stopPropagation(); deleteSubscription(${product.id})" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é">
                                                   <svg class="trash-icon" viewBox="0 0 24 24">
                                                       <path d="M3 6h18"></path>
                                                       <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                                       <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                                       <line x1="10" y1="11" x2="10" y2="17"></line>
                                                       <line x1="14" y1="11" x2="14" y2="17"></line>
                                                   </svg>
                                               </button>` : 
                                               ''
                                           }
                                           ${product.plugin_group !== 'settings' ? 
                                               `<svg class="expand-arrow" viewBox="0 0 24 24">
                                                   <polyline points="6,9 12,15 18,9"></polyline>
                                               </svg>` : 
                                               ''
                                           }
                                       </div>
                                   </div>
                               </div>
                               <div class="product-details" id="product-details-${product.id}">
                                   <div class="loading-spinner" id="loading-${product.id}" style="display: none;"></div>
                                   <div id="products-list-${product.id}"></div>
                               </div>
                           `;
                       }).join('')}
                   `;

                   container.innerHTML = tableHTML;
               }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        function showNoProducts() {
            const container = document.getElementById('userProducts');
            container.innerHTML = `
                <div class="loading-products">
                    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤</p>
                    <a href="./pricing/" class="btn" style="margin-top: 1rem;">–ö—É–ø–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã</a>
                </div>
            `;
        }

        // –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
        function getProductDisplayName(productName) {
            const names = {
                'dataviewer': 'DataViewer',
                'DataHub': 'DataHub',
                'authorization': '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
                'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'
            };
            return names[productName] || productName;
        }

               // –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
               async function cancelSubscription(productId) {
                   if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É?')) {
                       return;
                   }

                   const token = localStorage.getItem('authToken');
                   if (!token) return;

                   try {
                       const response = await fetch('/auth-api.php/api/cancel-subscription', {
                           method: 'POST',
                           headers: {
                               'Content-Type': 'application/json',
                               'Authorization': 'Bearer ' + token
                           },
                           body: JSON.stringify({
                               product_id: productId
                           })
                       });

                       const result = await response.json();
                       
                       if (response.ok) {
                           alert('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
                           loadUserProducts(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫
                       } else {
                           alert('–û—à–∏–±–∫–∞: ' + result.error);
                       }
                   } catch (error) {
                       console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏:', error);
                       alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø–æ–¥–ø–∏—Å–∫–∏');
                   }
               }

               // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
               async function deleteSubscription(productId) {
                   if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–∑–∏—Ü–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                       return;
                   }

                   const token = localStorage.getItem('authToken');
                   if (!token) return;

                   try {
                       const response = await fetch('/auth-api.php/api/delete-subscription', {
                           method: 'POST',
                           headers: {
                               'Content-Type': 'application/json',
                               'Authorization': 'Bearer ' + token
                           },
                           body: JSON.stringify({
                               product_id: productId
                           })
                       });

                       const result = await response.json();
                       
                       if (response.ok) {
                           alert('–ü–æ–∑–∏—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
                           loadUserProducts(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫
                       } else {
                           alert('–û—à–∏–±–∫–∞: ' + result.error);
                       }
                   } catch (error) {
                       console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏:', error);
                       alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–∑–∏—Ü–∏–∏');
                   }
               }


        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        async function loadSettings() {
            const token = localStorage.getItem('authToken');
            console.log('loadSettings: Token found:', token ? 'YES' : 'NO');
            if (!token) {
                console.log('loadSettings: No token, returning');
                return;
            }

            try {
                console.log('loadSettings: Making request to /api/me');
                console.log('loadSettings: Token being sent:', token.substring(0, 20) + '...');
                const response = await fetch('/auth-api.php/api/me', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token
                    })
                });
                console.log('loadSettings: Response status:', response.status);
                const result = await response.json();
                console.log('loadSettings: Response data:', result);

                if (response.ok && result.user) {
                    console.log('loadSettings: Displaying user data:', result.user);
                    displaySettings(result.user);
                } else {
                    console.log('loadSettings: Error - no user data or response not ok');
                    showSettingsError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                showSettingsError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function displaySettings(user) {
            console.log('displaySettings: Called with user:', user);
            const container = document.getElementById('settingsContent');
            console.log('displaySettings: Container found:', container);
            
            container.innerHTML = `
                <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                <div class="settings-section">
                    <h3 class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-icon lucide-user" style="display: inline-block; margin-right: 8px; vertical-align: middle;">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </h3>
                    <form id="profileForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profileName">–ò–º—è</label>
                                <input type="text" id="profileName" name="name" value="${user.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="profileLogin">–õ–æ–≥–∏–Ω</label>
                                <input type="text" id="profileLogin" name="login" value="${user.login || ''}" required minlength="3" maxlength="20" pattern="[a-zA-Z0-9_]+" title="–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profileEmail">Email</label>
                                <input type="email" id="profileEmail" name="email" value="${user.email || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="profileUserType">–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                                <input type="text" id="profileUserType" value="${getUserTypeDisplay(user.user_type)}" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profilePhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" id="profilePhone" name="phone" value="${user.phone || ''}">
                            </div>
                            <div class="form-group">
                                <label for="profileCompany">–ö–æ–º–ø–∞–Ω–∏—è</label>
                                <input type="text" id="profileCompany" name="company_name" value="${user.company_name || ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="profileUserType">–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <input type="text" id="profileUserType" value="${getUserTypeDisplay(user.user_type)}" readonly>
                        </div>
                        <button type="submit" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </form>
                </div>

                <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
                <div class="settings-section">
                    <h3 class="section-title">üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
                    <form id="passwordForm">
                        <div class="form-group">
                            <label for="currentPassword">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                            <input type="password" id="currentPassword" name="current_password" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="newPassword" name="new_password" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                                <input type="password" id="confirmPassword" name="confirm_password" required>
                            </div>
                        </div>
                        <button type="submit" class="btn-save">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                    </form>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ -->
                <div class="settings-section">
                    <h3 class="section-title">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</h3>
                    <div class="form-group">
                        <label class="toggle-label">
                            <span>–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoRenewal" checked>
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="toggle-label">
                            <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="expiryNotifications" checked>
                                <span class="slider"></span>
                            </label>
                        </label>
                    </div>
                    <button class="btn-save" onclick="exportSubscriptions()">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</button>
                </div>

                <!-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (–∑–∞–≥–æ—Ç–æ–≤–∫–∞) -->
                <div class="settings-section">
                    <h3 class="section-title">üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>
                    <p style="color: #999; margin-bottom: 1rem;">–§—É–Ω–∫—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö</p>
                    <div class="form-group">
                        <label>–ò—Å—Ç–æ—Ä–∏—è –≤—Ö–æ–¥–æ–≤</label>
                        <p style="color: #999; font-size: 0.9rem;">–ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</p>
                    </div>
                    <div class="form-group">
                        <label>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏</label>
                        <p style="color: #999; font-size: 0.9rem;">–ü–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</p>
                    </div>
                </div>

                <!-- –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ -->
                <div class="danger-zone">
                    <h3 class="section-title">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</h3>
                    <p style="color: #ccc; margin-bottom: 1rem;">
                        –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–æ–ª–Ω–æ–π –ø–æ—Ç–µ—Ä–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–¥–ø–∏—Å–æ–∫. 
                        –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
                    </p>
                    <button class="btn-danger" onclick="deleteProfile()">–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                </div>
            `;

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            document.getElementById('passwordForm').addEventListener('submit', handlePasswordChange);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        async function handleProfileUpdate(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                const response = await fetch('/auth-api.php/api/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω');
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
                    const user = JSON.parse(localStorage.getItem('user'));
                    Object.assign(user, data);
                    localStorage.setItem('user', JSON.stringify(user));
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
        async function handlePasswordChange(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            if (data.new_password !== data.confirm_password) {
                alert('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
                return;
            }
            
            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                const response = await fetch('/auth-api.php/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω');
                    event.target.reset();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è');
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–¥–ø–∏—Å–æ–∫
        function exportSubscriptions() {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            fetch('/auth-api.php/api/user-products', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.products) {
                    const dataStr = JSON.stringify(result.products, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'subscriptions.json';
                    link.click();
                    URL.revokeObjectURL(url);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö');
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
        async function deleteProfile() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –∏ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–æ—Ç–µ—Ä–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö.')) {
                return;
            }
            
            if (!confirm('–≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ. –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–¥–ø–∏—Å–∫–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                return;
            }

            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                const response = await fetch('/auth-api.php/api/delete-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('–ü—Ä–æ—Ñ–∏–ª—å —É–¥–∞–ª–µ–Ω');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = './auth/';
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function showSettingsError(message) {
            const container = document.getElementById('settingsContent');
            container.innerHTML = `
                <div class="error" style="text-align: center; padding: 2rem;">
                    <p>${message}</p>
                    <button class="btn-save" onclick="loadSettings()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                </div>
            `;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUserProducts();
            loadSettings();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Ä—Å–∏–∏ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã DOM —Ç–æ—á–Ω–æ –±—ã–ª –≥–æ—Ç–æ–≤
            setTimeout(() => {
                loadDownloadVersions();
            }, 100);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            document.getElementById('downloadBtn').addEventListener('click', downloadMSI);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
            setTimeout(() => {
                loadHelpMaterials();
            }, 200);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
            document.getElementById('downloadHelpBtn').addEventListener('click', downloadHelpMaterial);
        });
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        async function loadHelpMaterials() {
            try {
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤...');
                
                const response = await fetch('./api/get-help-folders.php');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç API:', data);
                
                if (!data.success) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–∞–ø–æ–∫');
                }
                
                const folders = data.folders || [];
                console.log('–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–∞–ø–∫–∏:', folders);
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç
                const helpSelect = document.getElementById('helpMaterialSelect');
                if (helpSelect) {
                    helpSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>';
                    
                    folders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder;
                        option.textContent = folder;
                        helpSelect.appendChild(option);
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    helpSelect.addEventListener('change', updateHelpDownloadButton);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:', error);
                
                // Fallback - –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                const helpSelect = document.getElementById('helpMaterialSelect');
                if (helpSelect) {
                    helpSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</option>';
                    
                    const testFolders = [
                        '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è_DataViewer',
                        '–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                        'FAQ_–ø–æ_–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é',
                        '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è_–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è'
                    ];
                    
                    testFolders.forEach(folder => {
                        const option = document.createElement('option');
                        option.value = folder;
                        option.textContent = folder;
                        helpSelect.appendChild(option);
                    });
                    
                    helpSelect.addEventListener('change', updateHelpDownloadButton);
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        function updateHelpDownloadButton() {
            const helpSelect = document.getElementById('helpMaterialSelect');
            const downloadBtn = document.getElementById('downloadHelpBtn');
            
            if (helpSelect && downloadBtn) {
                downloadBtn.disabled = !helpSelect.value;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
        async function downloadHelpMaterial() {
            const helpSelect = document.getElementById('helpMaterialSelect');
            const selectedFolder = helpSelect.value;
            
            if (!selectedFolder) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
                return;
            }
            
            try {
                console.log(`–°–∫–∞—á–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ –ø–∞–ø–∫–∏: ${selectedFolder}`);
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ —á–µ—Ä–µ–∑ API
                const response = await fetch(`./api/get-help-files.php?folder=${encodeURIComponent(selectedFolder)}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç API –¥–ª—è —Ñ–∞–π–ª–æ–≤:', data);
                
                if (!data.success) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤');
                }
                
                const files = data.files || [];
                if (files.length === 0) {
                    alert('–ê—Ä—Ö–∏–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ');
                    return;
                }
                
                // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª (–∞—Ä—Ö–∏–≤)
                const archiveFile = files[0];
                console.log(`–ù–∞–π–¥–µ–Ω –∞—Ä—Ö–∏–≤: ${archiveFile.name}`);
                
                // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const downloadUrl = `./installer/Help_information/${selectedFolder}/${archiveFile.name}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = archiveFile.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ:', downloadUrl);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }
    </script>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–µ—Ä—Å–∏–∏ -->
    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–°–∫–∞—á–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç</h2>
                <span class="close" onclick="closeDownloadModal()">&times;</span>
            </div>
            
            <div class="version-selector">
                <label for="revitVersion">–í–µ—Ä—Å–∏—è Revit:</label>
                <select id="revitVersion" onchange="loadVersions()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é Revit</option>
                    <option value="2023">Revit 2023</option>
                    <option value="2024">Revit 2024</option>
                    <option value="2025">Revit 2025</option>
                </select>
            </div>
            
            <div class="version-selector">
                <label for="productVersion">–í–µ—Ä—Å–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞:</label>
                <select id="productVersion" onchange="showVersionInfo()">
                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é Revit</option>
                </select>
            </div>
            
            <div id="versionInfo" class="version-info" style="display: none;">
                <h4>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏–∏</h4>
                <p id="versionDescription"></p>
                <p id="versionSize"></p>
                <p id="versionDate"></p>
            </div>
            
            <div class="modal-actions">
                <button class="btn-modal btn-modal-secondary" onclick="closeDownloadModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-modal btn-modal-primary" id="downloadBtn" onclick="downloadVersion()" disabled>–°–∫–∞—á–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let currentProduct = '';
        let availableVersions = [];
        
        function showDownloadModal(productName) {
            currentProduct = productName;
            document.getElementById('downloadModal').style.display = 'block';
            document.getElementById('revitVersion').value = '';
            document.getElementById('productVersion').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é Revit</option>';
            document.getElementById('versionInfo').style.display = 'none';
            document.getElementById('downloadBtn').disabled = true;
        }
        
        function closeDownloadModal() {
            document.getElementById('downloadModal').style.display = 'none';
        }
        
        async function loadVersions() {
            const revitVersion = document.getElementById('revitVersion').value;
            if (!revitVersion) return;
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/auth-api.php/api/product-versions?product=${currentProduct}&revit_version=${revitVersion}`, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                const result = await response.json();
                availableVersions = result.versions || [];
                
                const select = document.getElementById('productVersion');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞</option>';
                
                availableVersions.forEach(version => {
                    const option = document.createElement('option');
                    option.value = version.id;
                    option.textContent = `v${version.version} (${new Date(version.release_date).toLocaleDateString('ru-RU')})`;
                    select.appendChild(option);
                });
                
                document.getElementById('versionInfo').style.display = 'none';
                document.getElementById('downloadBtn').disabled = true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–µ—Ä—Å–∏–π:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–µ—Ä—Å–∏–π –ø—Ä–æ–¥—É–∫—Ç–∞');
            }
        }
        
        function showVersionInfo() {
            const versionId = document.getElementById('productVersion').value;
            if (!versionId) {
                document.getElementById('versionInfo').style.display = 'none';
                document.getElementById('downloadBtn').disabled = true;
                return;
            }
            
            const version = availableVersions.find(v => v.id == versionId);
            if (version) {
                document.getElementById('versionDescription').textContent = version.description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
                document.getElementById('versionSize').textContent = `–†–∞–∑–º–µ—Ä: ${(version.file_size / 1024 / 1024).toFixed(2)} MB`;
                document.getElementById('versionDate').textContent = `–î–∞—Ç–∞ –≤—ã–ø—É—Å–∫–∞: ${new Date(version.release_date).toLocaleDateString('ru-RU')}`;
                document.getElementById('versionInfo').style.display = 'block';
                document.getElementById('downloadBtn').disabled = false;
            }
        }
        
        async function downloadVersion() {
            const versionId = document.getElementById('productVersion').value;
            if (!versionId) return;
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch('/auth-api.php/api/download-version', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ version_id: versionId })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    const link = document.createElement('a');
                    link.href = result.download_url;
                    link.download = result.file_name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    closeDownloadModal();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞');
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('downloadModal');
            if (event.target === modal) {
                closeDownloadModal();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è —Å–ø–∏—Å–∫–æ–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        let expandedProducts = new Set();
        let subscriptionData = new Map();
        let productActivations = new Map();
        
        async function toggleProductDetails(productId, pluginGroup) {
            const detailsElement = document.getElementById(`product-details-${productId}`);
            const arrowElement = document.querySelector(`[onclick*="toggleProductDetails(${productId}"] .expand-arrow`);
            const loadingElement = document.getElementById(`loading-${productId}`);
            const productsListElement = document.getElementById(`products-list-${productId}`);
            
            if (expandedProducts.has(productId)) {
                // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
                detailsElement.classList.remove('expanded');
                arrowElement.classList.remove('expanded');
                expandedProducts.delete(productId);
            } else {
                // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º
                detailsElement.classList.add('expanded');
                arrowElement.classList.add('expanded');
                expandedProducts.add(productId);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                loadingElement.style.display = 'block';
                productsListElement.innerHTML = '';
                
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥—É–∫—Ç–∞—Ö –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è—Ö
                    const [products, activations] = await Promise.all([
                        loadSubscriptionProducts(pluginGroup),
                        loadProductActivations()
                    ]);
                    displaySubscriptionProducts(productId, products, activations);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', error);
                    productsListElement.innerHTML = '<div style="color: #ef4444; padding: 16px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>';
                } finally {
                    loadingElement.style.display = 'none';
                }
            }
        }
        
        async function loadSubscriptionProducts(pluginGroup) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            if (subscriptionData.has(pluginGroup)) {
                const cached = subscriptionData.get(pluginGroup);
                const cacheTime = new Date(cached.timestamp);
                const now = new Date();
                
                // –ï—Å–ª–∏ –∫—ç—à —Å–≤–µ–∂–∏–π (–º–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (now - cacheTime < 5 * 60 * 1000) {
                    return cached.products;
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
            const token = localStorage.getItem('authToken');
            const response = await fetch(`/auth-api.php/api/subscription-products?subscription=${encodeURIComponent(pluginGroup)}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
            
            const result = await response.json();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            subscriptionData.set(pluginGroup, {
                products: result.products,
                timestamp: result.cache_timestamp
            });
            
            return result.products;
        }
        
        async function loadProductActivations() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            if (productActivations.has('activations')) {
                const cached = productActivations.get('activations');
                const cacheTime = new Date(cached.timestamp);
                const now = new Date();
                
                // –ï—Å–ª–∏ –∫—ç—à —Å–≤–µ–∂–∏–π (–º–µ–Ω–µ–µ 5 –º–∏–Ω—É—Ç), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (now - cacheTime < 5 * 60 * 1000) {
                    return cached.activations;
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
            const token = localStorage.getItem('authToken');
            const response = await fetch('/auth-api.php/api/product-activations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token: token })
            });
            
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–π');
            }
            
            const result = await response.json();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            productActivations.set('activations', {
                activations: result.activations,
                timestamp: new Date().toISOString()
            });
            
            return result.activations;
        }
        
        function displaySubscriptionProducts(productId, products, activations) {
            const productsListElement = document.getElementById(`products-list-${productId}`);
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            console.log('displaySubscriptionProducts called with:', {
                productId,
                products,
                activations
            });
            
            // –ù–∞—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –ø–æ product_id
            const productActivation = activations.find(act => 
                act.product_id == productId
            );
            
            console.log(`Looking for activations for productId ${productId}:`, {
                productActivation,
                allActivations: activations
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
            if (!productActivation || !productActivation.revit_versions || productActivation.revit_versions.length === 0) {
                productsListElement.innerHTML = '<div style="color: #9ca3af; padding: 16px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –≤ –ø–ª–∞–≥–∏–Ω–µ Revit.</div>';
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏–π
            const activationsHTML = `
                <div class="activations-section">
                    <h4>–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏:</h4>
                    ${productActivation.revit_versions.map(revitActivation => `
                        <div class="activation-row">
                            <span class="revit-version">Revit ${revitActivation.revit_version}</span>
                            <span class="product-version">–í–µ—Ä—Å–∏—è ${revitActivation.product_version}</span>
                            <span class="activation-status ${revitActivation.activation_status}">
                                ${revitActivation.activation_status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ì–æ—Ç–æ–≤'}
                            </span>
                            ${revitActivation.activation_status === 'active' ? 
                                `<button class="btn-activate" onclick="toggleActivation(${productId}, '${revitActivation.revit_version}', '${revitActivation.activation_status}')">
                                    –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                                </button>` : 
                                `<span class="activation-note">–ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –≤ –ø–ª–∞–≥–∏–Ω–µ Revit</span>`
                            }
                        </div>
                    `).join('')}
                </div>
            `;
            
            productsListElement.innerHTML = activationsHTML;
        }
        
        function updateVersionOptions(productId, productName) {
            const platformSelect = document.getElementById(`platform-${productId}-${productName}`);
            const versionSelect = document.getElementById(`version-${productId}-${productName}`);
            const downloadBtn = document.getElementById(`download-${productId}-${productName}`);
            
            const selectedPlatform = platformSelect.value;
            const productData = window[`productData_${productId}_${productName}`];
            
            // –û—á–∏—â–∞–µ–º –≤–µ—Ä—Å–∏–∏
            versionSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é</option>';
            downloadBtn.disabled = true;
            
            if (selectedPlatform && productData) {
                // –§–∏–ª—å—Ç—Ä—É–µ–º –≤–µ—Ä—Å–∏–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
                const availableVersions = productData
                    .filter(p => p.platform === selectedPlatform)
                    .map(p => p.version)
                    .sort();
                
                availableVersions.forEach(version => {
                    const option = document.createElement('option');
                    option.value = version;
                    option.textContent = version;
                    versionSelect.appendChild(option);
                });
            }
        }
        
        function updateDownloadButton(productId, productName) {
            const platformSelect = document.getElementById(`platform-${productId}-${productName}`);
            const versionSelect = document.getElementById(`version-${productId}-${productName}`);
            const downloadBtn = document.getElementById(`download-${productId}-${productName}`);
            
            const selectedPlatform = platformSelect.value;
            const selectedVersion = versionSelect.value;
            
            downloadBtn.disabled = !(selectedPlatform && selectedVersion);
        }
        
        async function downloadProductFile(productId, productName) {
            const platformSelect = document.getElementById(`platform-${productId}-${productName}`);
            const versionSelect = document.getElementById(`version-${productId}-${productName}`);
            
            const selectedPlatform = platformSelect.value;
            const selectedVersion = versionSelect.value;
            
            if (!selectedPlatform || !selectedVersion) return;
            
            const productData = window[`productData_${productId}_${productName}`];
            const selectedProduct = productData.find(p => 
                p.platform === selectedPlatform && p.version === selectedVersion
            );
            
            if (!selectedProduct) {
                alert('–û—à–∏–±–∫–∞: –ø—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            try {
                const token = localStorage.getItem('authToken');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const downloadBtn = document.getElementById(`download-${productId}-${productName}`);
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                downloadBtn.disabled = true;
                
                const response = await fetch('/auth-api.php/api/download-version', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        subscription: selectedProduct.subscription,
                        product: selectedProduct.product,
                        platform: selectedProduct.platform,
                        version: selectedProduct.version
                    })
                });
                
                if (response.ok) {
                    // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let fileName = selectedProduct.relative_path.split('/').pop();
                    
                    if (contentDisposition) {
                        const fileNameMatch = contentDisposition.match(/filename="(.+)"/);
                        if (fileNameMatch) {
                            fileName = fileNameMatch[1];
                        }
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º blob –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    alert('MSI —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Å–∫–∞—á–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    const result = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ MSI —Ñ–∞–π–ª–∞');
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                const downloadBtn = document.getElementById(`download-${productId}-${productName}`);
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
        async function toggleActivation(productId, revitVersion, currentStatus) {
            try {
                const token = localStorage.getItem('authToken');
                const endpoint = currentStatus === 'active' ? 'deactivate-product' : 'activate-product';
                
                const response = await fetch(`/auth-api.php/api/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        revit_version: revitVersion
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // –û—á–∏—â–∞–µ–º –∫—ç—à –∞–∫—Ç–∏–≤–∞—Ü–∏–π
                    productActivations.delete('activations');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    const productRow = document.querySelector(`[onclick*="toggleProductDetails(${productId}"]`);
                    if (productRow) {
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
                        const detailsElement = document.getElementById(`product-details-${productId}`);
                        if (detailsElement.classList.contains('expanded')) {
                            // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–Ω–æ–≤–æ
                            detailsElement.classList.remove('expanded');
                            setTimeout(() => {
                                productRow.click();
                            }, 100);
                        }
                    }
                    
                    alert(result.message || '–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏');
            }
        }
        
    </script>
</body>
</html>
